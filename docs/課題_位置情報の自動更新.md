# 課題: 車載利用時に画面が自動更新されない

## 現象

実際に車でダミー経路を走行して利用したところ、**ブラウザ画面が開いたときのまま更新されず、手動で更新しないと情報が変わらなかった**。走行中は手動更新は現実的でなく、仕様として耐えられない。

---

## 想定される原因

### 1. watchPosition が実質動いていない（実装上の不具合）

`useGeolocation` の `useEffect` で `watchPosition` を開始する条件が **「`position` が既に存在するとき」** になっている。  
初回は `position` が `null` のためこの effect では何もせず、その後に `getCurrentPosition` で `position` がセットされても、**依存配列に `position` が入っていないため effect が再実行されず、`watchPosition` が一度も開始されていない**可能性がある。

- **場所**: `src/hooks/useGeolocation.ts` の第2の `useEffect`
- **結果**: 位置は初回1回だけ取得され、以降の移動で更新されない

### 2. ブラウザの位置情報の更新間隔・キャッシュ

- `maximumAge: 10000`（10秒）のため、**10秒間はキャッシュ位置を返す**ことがある。走行中でも「前回の位置」が返り続け、画面が動かないように見える。
- スマホ・車載では GPS の更新間隔が元々長い場合があり、`watchPosition` のコールバックが思ったより少ないことがある。

### 3. タブがバックグラウンドになったときの制限

- 別アプリや別タブに切り替えると、ブラウザはバッテリ節約のため **タイマーや位置監視を止めたり間引きしたりする**。
- 再度アプリのタブを前面に戻したときに、**自動では位置を再取得していない**可能性がある。

---

## 修正案

### 案A: watchPosition を確実に動かす（必須）

1. **watch 開始条件の見直し**
   - 「`position` が存在するときだけ watch を開始する」をやめる。
   - **マウント時点で `watch === true` なら、すぐに `watchPosition` を開始する**。
   - 初回表示用の `getCurrentPosition()` はそのまま残し、最初の1回はそれで表示し、以降は `watchPosition` のコールバックで更新する。

2. **期待する動き**
   - アプリを開くと、初回位置表示＋その後の移動に応じて画面（距離・近隣事故）が自動で更新される。

### 案B: 位置更新を「より頻繁・新鮮」にする

1. **Geolocation オプションの調整**
   - `maximumAge`: 10000 → **3000〜5000**（3〜5秒）に短縮し、古いキャッシュを使いにくくする。
   - 必要に応じて `timeout` も調整（例: 15000 → 10000）。

2. **定期的な再取得のフォールバック**
   - `watchPosition` に加え、**一定間隔（例: 8〜10秒）で `getCurrentPosition()` を呼ぶタイマー**を設ける。
   - 端末やブラウザによっては `watchPosition` のコールバックが少ない場合があるため、このフォールバックで確実に更新する。

### 案C: タブを再度表示したときに必ず更新する

1. **Page Visibility API の利用**
   - `document.visibilityState` が `"visible"` に変わったとき（タブを前面に戻したとき）に、**その場で `getCurrentPosition()` を実行して状態を更新**する。
   - バックグラウンド中に止まっていた分を、ユーザーがアプリを見た瞬間に補正できる。

### 案D: UI で「更新されている」ことを分かりやすくする

1. **最終更新時刻の表示**
   - 「最終更新: ○○秒前」のように表示する。更新されていれば「○秒前」が変わり、止まっていれば「30秒前」のままになるので、不具合に気づきやすい。

2. **手動更新ボタン**
   - 「位置を更新」のような大きなボタンを常時表示する。自動更新が止まったときでも、運転の合間に1タップで最新位置に更新できるようにする。

3. **更新が止まったときの案内（任意）**
   - 最終更新が一定時間（例: 30秒）を超えたら、「位置が古くなっています。更新ボタンを押してください」などのメッセージを出す。

---

## 推奨する実施順

| 優先度 | 内容 | 効果 |
|--------|------|------|
| 1 | **案A**: watchPosition を条件によらず開始する | 走行中に画面が自動で更新されるようにする（根本対応） |
| 2 | **案B**: maximumAge 短縮＋定期 getCurrentPosition のフォールバック | 更新の確実性・頻度の向上 |
| 3 | **案C**: タブ表示復帰時に位置を再取得 | 一度別タブにしたあとでも、戻した瞬間に最新になる |
| 4 | **案D**: 最終更新表示＋更新ボタン | 運用時の安心感と、自動が止まったときの逃げ道 |

まずは **案A を確実に実装**し、必要に応じて案B〜Dを追加する形がよいと考えられます。

---

## 補足: ブラウザの制限について

- **バックグラウンド中の位置更新**は、ブラウザの仕様で制限されることがあります。アプリを前面で表示している間は上記で改善し、**完全にバックグラウンドで動かし続ける**必要がある場合は、将来のネイティブアプリ（Capacitor 等）での対応が現実的です。
